#!/usr/bin/env bash

set -x

cd "$HOME" || exit

system_type=$(uname -s)

if [ "$system_type" = "Darwin" ]; then
    if ! command -v brew >/dev/null 2>&1; then
        echo "Installing homebrew"
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    echo "Updating homebrew bundles"
    cd "$HOME" && brew doctor && brew bundle
else
    sudo apt-get update
    sudo apt-get install -y $(cat Aptfile)

    # Install Node.js via NodeSource (LTS version)
    if ! command -v node >/dev/null 2>&1; then
        curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
        sudo apt-get install -y nodejs
    fi

    # Install Neovim from GitHub releases (latest stable)
    if ! command -v nvim >/dev/null 2>&1; then
        arch=$(uname -m)
        if [ "$arch" = "x86_64" ]; then
            nvim_arch="x86_64"
        elif [ "$arch" = "aarch64" ] || [ "$arch" = "arm64" ]; then
            nvim_arch="arm64"
        fi
        curl -fLo /tmp/nvim.tar.gz "https://github.com/neovim/neovim/releases/download/stable/nvim-linux-${nvim_arch}.tar.gz"
        sudo tar -xzf /tmp/nvim.tar.gz -C /opt
        sudo ln -sf /opt/nvim-linux-${nvim_arch}/bin/nvim /usr/local/bin/nvim
        rm /tmp/nvim.tar.gz
    fi

    # Install antidote (zsh plugin manager, antibody successor)
    if [ ! -d "$HOME/.antidote" ]; then
        git clone --depth=1 https://github.com/mattmc3/antidote.git "$HOME/.antidote"
    fi

    # Install pyenv
    if [ ! -d "$HOME/.pyenv" ]; then
        git clone https://github.com/pyenv/pyenv.git "$HOME/.pyenv"
    fi

    # Install rbenv and ruby-build
    if [ ! -d "$HOME/.rbenv" ]; then
        git clone https://github.com/rbenv/rbenv.git "$HOME/.rbenv"
        git clone https://github.com/rbenv/ruby-build.git "$HOME/.rbenv/plugins/ruby-build"
    fi

    # Install starship prompt
    if ! command -v starship >/dev/null 2>&1; then
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    fi

    # LSP servers
    sudo npm install -g pyright typescript typescript-language-server bash-language-server tree-sitter-cli
    sudo gem install solargraph
    sudo GOBIN=/usr/local/bin /usr/bin/go install golang.org/x/tools/gopls@latest
fi
# neovim native packages
PACK_DIR="$HOME/.local/share/nvim/site/pack/plugins/start"
mkdir -p "$PACK_DIR"

clone_plugin() {
    local repo=$1
    local name=$(basename "$repo" .git)
    if [ ! -d "$PACK_DIR/$name" ]; then
        git clone --depth 1 "https://github.com/$repo.git" "$PACK_DIR/$name"
    else
        git -C "$PACK_DIR/$name" pull --ff-only 2>/dev/null || true
    fi
}

clone_plugin "nvim-lua/plenary.nvim"
clone_plugin "nvim-telescope/telescope.nvim"
clone_plugin "nvim-treesitter/nvim-treesitter"
clone_plugin "tpope/vim-fugitive"

# neovim dependencies
if [ "$system_type" = "Darwin" ]; then
    python3 -m pip install --user --upgrade pip setuptools wheel pynvim
    npm install -g neovim diff-so-fancy
else
    # Use pip for pynvim (avoids apt pulling in old neovim as dependency)
    python3 -m pip install --break-system-packages --user pynvim
    sudo npm install -g neovim diff-so-fancy
fi

# Configure git to use diff-so-fancy
git config --global core.pager "diff-so-fancy | less --tabs=4 -RFX"
git config --global interactive.diffFilter "diff-so-fancy --patch"
git config --global color.ui true
git config --global color.diff-highlight.oldNormal "red bold"
git config --global color.diff-highlight.oldHighlight "red bold 52"
git config --global color.diff-highlight.newNormal "green bold"
git config --global color.diff-highlight.newHighlight "green bold 22"

# Install treesitter parsers
nvim --headless -c "lua require('nvim-treesitter').install({'lua', 'vim', 'vimdoc', 'javascript', 'typescript', 'python', 'go', 'bash', 'json', 'yaml', 'markdown'})" -c "sleep 30" -c "qa" 2>/dev/null || true

# Bootstrap tmux
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    mkdir -p "$HOME/.tmux/plugins"
    # installing tmux-plugin-manager and plugins
    git clone https://github.com/tmux-plugins/tpm "$HOME/.tmux/plugins/tpm"
    "$HOME"/.tmux/plugins/tpm/bin/install_plugins
else
    # updating tpm and plugins
    cd "$HOME/.tmux/plugins/tpm" || git pull -p
    cd "$HOME" || "$HOME"/.tmux/plugins/tpm/bin/update_plugins all
fi
# termino
tic "$HOME/.terminfo/xterm-256color-italic.terminfo"
# changing the shell to zsh for interactive sessions only
case $- in
  *) echo "Running in a script, not changing default shell"
     ;;
  *i*) echo ">>> Please enter you password to make zsh your default shell."
    chsh -s "$(command -v zsh)" || echo "*** Failed to chsh, please run it manually"
    ;;
esac

# Clean up non-dotfiles that shouldn't remain in $HOME
rm -f "$HOME/Dockerfile" "$HOME/.dockerignore" "$HOME/README.md" "$HOME/Aptfile" "$HOME/Brewfile"
rm -rf "$HOME/.github"
